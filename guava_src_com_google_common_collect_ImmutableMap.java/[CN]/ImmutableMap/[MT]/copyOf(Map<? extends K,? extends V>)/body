{
  if ((map instanceof ImmutableMap) && !(map instanceof ImmutableSortedMap)) {
    @SuppressWarnings("unchecked") ImmutableMap<K,V> kvMap=(ImmutableMap<K,V>)map;
    if (!kvMap.isPartialView()) {
      return kvMap;
    }
  }
 else   if (map instanceof EnumMap) {
    EnumMap<?,?> enumMap=(EnumMap<?,?>)map;
    for (    Map.Entry<?,?> entry : enumMap.entrySet()) {
      checkNotNull(entry.getKey());
      checkNotNull(entry.getValue());
    }
    @SuppressWarnings("unchecked") ImmutableMap<K,V> result=ImmutableEnumMap.asImmutable(new EnumMap(enumMap));
    return result;
  }
  Entry<?,?>[] entries=map.entrySet().toArray(EMPTY_ENTRY_ARRAY);
  return fromEntries(entries.length,entries);
}

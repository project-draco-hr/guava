{
  Throwable cause=exception.getCause();
  if (cause == null) {
    throw exception;
  }
  if (combineStackTraces) {
    StackTraceElement[] causeTrace=cause.getStackTrace();
    StackTraceElement[] outerTrace=exception.getStackTrace();
    StackTraceElement[] combined=new StackTraceElement[causeTrace.length + outerTrace.length];
    System.arraycopy(causeTrace,0,combined,0,causeTrace.length);
    System.arraycopy(outerTrace,0,combined,causeTrace.length,outerTrace.length);
    cause.setStackTrace(combined);
  }
  if (cause instanceof Exception) {
    throw (Exception)cause;
  }
  if (cause instanceof Error) {
    throw (Error)cause;
  }
  throw exception;
}

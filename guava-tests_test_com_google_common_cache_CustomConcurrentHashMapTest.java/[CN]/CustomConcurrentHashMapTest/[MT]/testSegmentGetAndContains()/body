{
  CustomConcurrentHashMap<Object,Object> map=makeMap(createCacheBuilder().concurrencyLevel(1).expireAfterAccess(99999,SECONDS));
  Segment<Object,Object> segment=map.segments[0];
  Object key=new Object();
  int hash=map.hash(key);
  Object value=new Object();
  AtomicReferenceArray<ReferenceEntry<Object,Object>> table=segment.table;
  int index=hash & (table.length() - 1);
  ReferenceEntry<Object,Object> entry=map.newEntry(key,hash,null);
  ValueReference<Object,Object> valueRef=map.newValueReference(entry,value);
  entry.setValueReference(valueRef);
  assertNull(segment.get(key,hash));
  table.set(index,entry);
  assertNull(segment.get(key,hash));
  assertFalse(segment.containsKey(key,hash));
  assertFalse(segment.containsValue(value));
  segment.count++;
  assertSame(value,segment.get(key,hash));
  assertTrue(segment.containsKey(key,hash));
  assertTrue(segment.containsValue(value));
  assertNull(segment.get(new Object(),hash));
  DummyEntry<Object,Object> nullEntry=DummyEntry.create(null,hash,entry);
  Object nullValue=new Object();
  ValueReference<Object,Object> nullValueRef=map.newValueReference(nullEntry,nullValue);
  nullEntry.setValueReference(nullValueRef);
  table.set(index,nullEntry);
  assertSame(value,segment.get(key,hash));
  assertTrue(segment.containsKey(key,hash));
  assertTrue(segment.containsValue(value));
  assertFalse(segment.containsValue(nullValue));
  DummyEntry<Object,Object> dummy=DummyEntry.create(new Object(),hash,entry);
  Object dummyValue=new Object();
  ValueReference<Object,Object> dummyValueRef=map.newValueReference(dummy,dummyValue);
  dummy.setValueReference(dummyValueRef);
  table.set(index,dummy);
  assertSame(value,segment.get(key,hash));
  assertTrue(segment.containsKey(key,hash));
  assertTrue(segment.containsValue(value));
  assertTrue(segment.containsValue(dummyValue));
  dummy=DummyEntry.create(key,hash,entry);
  dummyValue=new Object();
  dummyValueRef=map.newValueReference(dummy,dummyValue);
  dummy.setValueReference(dummyValueRef);
  table.set(index,dummy);
  assertSame(dummyValue,segment.get(key,hash));
  assertTrue(segment.containsKey(key,hash));
  assertTrue(segment.containsValue(value));
  assertTrue(segment.containsValue(dummyValue));
  dummy.setExpirationTime(0);
  assertNull(segment.get(key,hash));
  assertFalse(segment.containsKey(key,hash));
  assertTrue(segment.containsValue(value));
  assertFalse(segment.containsValue(dummyValue));
}

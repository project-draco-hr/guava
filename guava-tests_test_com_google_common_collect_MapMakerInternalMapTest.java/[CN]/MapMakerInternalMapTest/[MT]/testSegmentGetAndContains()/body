{
  MapMakerInternalMap<Object,Object,?,?> map=makeMap(createMapMaker().concurrencyLevel(1).weakValues());
  Segment<Object,Object,?,?> segment=map.segments[0];
  Object key=new Object();
  int hash=map.hash(key);
  Object value=new Object();
  AtomicReferenceArray<? extends InternalEntry<Object,Object,?>> table=segment.table;
  int index=hash & (table.length() - 1);
  InternalEntry<Object,Object,?> entry=segment.newEntryForTesting(key,hash,null);
  segment.setValueForTesting(entry,value);
  assertNull(segment.get(key,hash));
  segment.setTableEntryForTesting(index,entry);
  assertNull(segment.get(key,hash));
  assertFalse(segment.containsKey(key,hash));
  assertFalse(segment.containsValue(value));
  segment.count++;
  assertSame(value,segment.get(key,hash));
  assertTrue(segment.containsKey(key,hash));
  assertTrue(segment.containsValue(value));
  assertNull(segment.get(new Object(),hash));
  InternalEntry<Object,Object,?> nullEntry=segment.newEntryForTesting(null,hash,entry);
  Object nullValue=new Object();
  WeakValueReference<Object,Object,?> nullValueRef=segment.newWeakValueReferenceForTesting(nullEntry,nullValue);
  segment.setWeakValueReferenceForTesting(nullEntry,nullValueRef);
  segment.setTableEntryForTesting(index,nullEntry);
  assertSame(value,segment.get(key,hash));
  assertTrue(segment.containsKey(key,hash));
  assertTrue(segment.containsValue(value));
  assertFalse(segment.containsValue(nullValue));
  InternalEntry<Object,Object,?> dummyEntry=segment.newEntryForTesting(new Object(),hash,entry);
  Object dummyValue=new Object();
  WeakValueReference<Object,Object,?> dummyValueRef=segment.newWeakValueReferenceForTesting(dummyEntry,dummyValue);
  segment.setWeakValueReferenceForTesting(dummyEntry,dummyValueRef);
  segment.setTableEntryForTesting(index,dummyEntry);
  assertSame(value,segment.get(key,hash));
  assertTrue(segment.containsKey(key,hash));
  assertTrue(segment.containsValue(value));
  assertTrue(segment.containsValue(dummyValue));
  dummyEntry=segment.newEntryForTesting(key,hash,entry);
  dummyValue=new Object();
  dummyValueRef=segment.newWeakValueReferenceForTesting(dummyEntry,dummyValue);
  segment.setWeakValueReferenceForTesting(dummyEntry,dummyValueRef);
  segment.setTableEntryForTesting(index,dummyEntry);
  assertSame(dummyValue,segment.get(key,hash));
  assertTrue(segment.containsKey(key,hash));
  assertTrue(segment.containsValue(value));
  assertTrue(segment.containsValue(dummyValue));
}

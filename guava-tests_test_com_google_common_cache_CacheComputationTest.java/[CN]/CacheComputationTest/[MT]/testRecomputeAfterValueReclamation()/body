{
  CountingLoader countingLoader=new CountingLoader();
  Cache<Object,Object> cache=CacheBuilder.newBuilder().weakValues().build(countingLoader);
  int iterations=10;
  WeakReference<Object> ref=new WeakReference<Object>(null);
  int expectedComputations=0;
  for (int i=0; i < iterations; i++) {
    Object oldValue=ref.get();
    if (oldValue == null) {
      expectedComputations++;
    }
    ref=new WeakReference<Object>(cache.getUnchecked(1));
    oldValue=null;
    Thread.sleep(i);
    System.gc();
  }
  assertEquals(expectedComputations,countingLoader.getCount());
}

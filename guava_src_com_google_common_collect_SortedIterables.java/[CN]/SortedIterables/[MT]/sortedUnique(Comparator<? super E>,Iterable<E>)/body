{
  if (elements instanceof Multiset) {
    elements=((Multiset<E>)elements).elementSet();
  }
  if (elements instanceof Set) {
    if (hasSameComparator(comparator,elements)) {
      return (Set<E>)elements;
    }
    List<E> list=Lists.newArrayList(elements);
    Collections.sort(list,comparator);
    return list;
  }
  E[] array=(E[])Iterables.toArray(elements);
  if (!hasSameComparator(comparator,elements)) {
    Arrays.sort(array,comparator);
  }
  return uniquifySortedArray(comparator,array);
}

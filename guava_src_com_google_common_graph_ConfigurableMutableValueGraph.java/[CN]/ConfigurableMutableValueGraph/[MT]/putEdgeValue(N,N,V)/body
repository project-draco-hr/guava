{
  checkNotNull(nodeA,"nodeA");
  checkNotNull(nodeB,"nodeB");
  checkNotNull(value,"value");
  GraphConnections<N,V> connectionsA=nodeConnections.get(nodeA);
  boolean isSelfLoop=nodeA.equals(nodeB);
  if (!allowsSelfLoops()) {
    checkArgument(!isSelfLoop,SELF_LOOPS_NOT_ALLOWED,nodeA);
  }
  if (connectionsA == null) {
    connectionsA=addNodeInternal(nodeA);
  }
  V previousValue=connectionsA.addSuccessor(nodeB,value);
  GraphConnections<N,V> connectionsB=nodeConnections.get(nodeB);
  if (connectionsB == null) {
    connectionsB=addNodeInternal(nodeB);
  }
  connectionsB.addPredecessor(nodeA,value);
  if (previousValue == null) {
    checkPositive(++edgeCount);
  }
  return previousValue;
}

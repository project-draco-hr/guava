{
  int utf16Length=sequence.length();
  long utf8Length=utf16Length;
  for (int i=0; i < utf16Length; i++) {
    char c=sequence.charAt(i);
    if (c < 0x80) {
    }
 else     if (c < 0x800) {
      utf8Length+=1;
    }
 else {
      utf8Length+=2;
      if (Character.MIN_SURROGATE <= c && c <= Character.MAX_SURROGATE) {
        int cp=Character.codePointAt(sequence,i);
        if (cp < Character.MIN_SUPPLEMENTARY_CODE_POINT) {
          throw new IllegalArgumentException("Unpaired surrogate at index " + i);
        }
        i++;
      }
    }
  }
  int result=(int)utf8Length;
  if (result != utf8Length) {
    throw new IllegalArgumentException("UTF-8 length does not fit in int: " + utf8Length);
  }
  return result;
}

{
  long size=file.length();
  if (size == 0) {
    return super.read();
  }
  if (size > Integer.MAX_VALUE) {
    throw new OutOfMemoryError("file is too large to fit in a byte array: " + size + " bytes");
  }
  byte[] bytes=new byte[(int)size];
  Closer closer=Closer.create();
  try {
    InputStream in=closer.register(openStream());
    int off=0;
    int read=0;
    while (off < size && ((read=in.read(bytes,off,(int)size - off)) != -1)) {
      off+=read;
    }
    byte[] result=bytes;
    if (off < size) {
      result=Arrays.copyOf(bytes,off);
    }
 else     if (read != -1) {
      ByteArrayOutputStream out=new ByteArrayOutputStream();
      ByteStreams.copy(in,out);
      byte[] moreBytes=out.toByteArray();
      result=new byte[bytes.length + moreBytes.length];
      System.arraycopy(bytes,0,result,0,bytes.length);
      System.arraycopy(moreBytes,0,result,bytes.length,moreBytes.length);
    }
    return result;
  }
 catch (  Throwable e) {
    throw closer.rethrow(e);
  }
 finally {
    closer.close();
  }
}

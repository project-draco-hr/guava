{
  lock.lock();
  try {
    State previous=snapshot.state;
    if (previous != State.STOPPING && previous != State.RUNNING) {
      IllegalStateException failure=new IllegalStateException("Cannot notifyStopped() when the service is " + previous);
      notifyFailed(failure);
      throw failure;
    }
    snapshot=new StateSnapshot(State.TERMINATED);
    terminated(previous);
  }
  finally {
    lock.unlock();
    executeListeners();
  }
}

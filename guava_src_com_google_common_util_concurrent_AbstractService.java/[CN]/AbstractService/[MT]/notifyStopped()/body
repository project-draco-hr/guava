{
  lock.lock();
  try {
    if (snapshot.state != State.STOPPING && snapshot.state != State.RUNNING) {
      IllegalStateException failure=new IllegalStateException("Cannot notifyStopped() when the service is " + snapshot.state);
      notifyFailed(failure);
      throw failure;
    }
    State previous=snapshot.state;
    snapshot=new StateSnapshot(State.TERMINATED);
    terminated(previous);
  }
  finally {
    lock.unlock();
    executeListeners();
  }
}

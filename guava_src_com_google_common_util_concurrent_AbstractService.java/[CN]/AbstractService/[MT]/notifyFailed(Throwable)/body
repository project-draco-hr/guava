{
  checkNotNull(cause);
  lock.lock();
  try {
    if (state == State.STARTING) {
      startup.setException(cause);
      shutdown.setException(new Exception("Service failed to start.",cause));
    }
 else     if (state == State.STOPPING) {
      shutdown.setException(cause);
    }
 else     if (state == State.RUNNING) {
      shutdown.setException(new Exception("Service failed while running",cause));
    }
 else     if (state == State.NEW || state == State.TERMINATED) {
      throw new IllegalStateException("Failed while in state:" + state,cause);
    }
    state=State.FAILED;
  }
  finally {
    lock.unlock();
  }
}

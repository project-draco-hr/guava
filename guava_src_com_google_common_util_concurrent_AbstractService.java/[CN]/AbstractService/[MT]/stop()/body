{
  lock.lock();
  try {
switch (snapshot.state) {
case NEW:
      snapshot=new StateSnapshot(State.TERMINATED);
    terminated(State.NEW);
  break;
case STARTING:
snapshot=new StateSnapshot(State.STARTING,true,null);
stopping(State.STARTING);
break;
case RUNNING:
snapshot=new StateSnapshot(State.STOPPING);
stopping(State.RUNNING);
doStop();
break;
case STOPPING:
case TERMINATED:
case FAILED:
break;
default :
throw new AssertionError("Unexpected state: " + snapshot.state);
}
}
 catch (Throwable shutdownFailure) {
notifyFailed(shutdownFailure);
}
 finally {
lock.unlock();
executeListeners();
}
return shutdown;
}

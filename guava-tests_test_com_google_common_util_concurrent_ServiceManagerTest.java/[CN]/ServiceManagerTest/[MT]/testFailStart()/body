{
  Service a=new NoOpService();
  Service b=new FailStartService();
  Service c=new NoOpService();
  Service d=new FailStartService();
  Service e=new NoOpService();
  ServiceManager manager=new ServiceManager(of(a,b,c,d,e));
  RecordingListener listener=new RecordingListener();
  manager.addListener(listener,MoreExecutors.sameThreadExecutor());
  assertState(manager,Service.State.NEW,a,b,c,d,e);
  try {
    manager.startAsync().awaitHealthy();
    fail("expected exception");
  }
 catch (  Throwable expected) {
    assertTrue(expected instanceof IllegalStateException);
  }
  assertFalse(listener.healthyCalled);
  assertState(manager,Service.State.RUNNING,a,c,e);
  assertEquals(of(b,d),listener.failedServices);
  assertState(manager,Service.State.FAILED,b,d);
  assertFalse(manager.isHealthy());
  manager.stopAsync().awaitStopped();
  assertFalse(manager.isHealthy());
  assertFalse(listener.healthyCalled);
  assertTrue(listener.stoppedCalled);
}

{
  resync(nowMicros);
  long microsToNextFreeTicket=max(0,nextFreeTicketMicros - nowMicros);
  double storedPermitsToSpend=min(requiredPermits,this.storedPermits);
  double freshPermits=requiredPermits - storedPermitsToSpend;
  long waitMicros=storedPermitsToWaitTime(this.storedPermits,storedPermitsToSpend) + (long)(freshPermits * stableIntervalMicros);
  this.nextFreeTicketMicros=nextFreeTicketMicros + waitMicros;
  this.storedPermits-=storedPermitsToSpend;
  return microsToNextFreeTicket;
}

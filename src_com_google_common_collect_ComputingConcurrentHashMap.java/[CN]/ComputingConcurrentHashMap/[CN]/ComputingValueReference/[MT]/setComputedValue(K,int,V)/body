{
  Segment segment=segmentFor(hash);
  segment.lock();
  try {
    segment.preWriteCleanup();
    int newCount=segment.count + 1;
    if (newCount > segment.threshold) {
      segment.expand();
    }
    for (ReferenceEntry<K,V> e=segment.getFirst(hash); e != null; e=e.getNext()) {
      K entryKey=e.getKey();
      if (e.getHash() == hash && entryKey != null && keyEquivalence.equivalent(key,entryKey)) {
        ValueReference<K,V> liveValueReference=e.getValueReference();
        if (liveValueReference == this) {
          ++segment.modCount;
          if (segment.evictEntries()) {
            newCount=segment.count + 1;
          }
          segment.setValue(e,value);
          segment.count=newCount;
        }
        return;
      }
    }
  }
  finally {
    segment.unlock();
    segment.postWriteCleanup();
  }
}

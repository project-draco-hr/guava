{
  assertEquals(from,Iterables.getLast(stateHistory));
  stateHistory.add(State.FAILED);
  assertEquals(State.FAILED,service.state());
  if (from == State.STARTING) {
    try {
      service.startAndWait();
      fail();
    }
 catch (    UncheckedExecutionException e) {
      assertEquals(failure,e.getCause());
    }
  }
  try {
    service.stopAndWait();
    fail();
  }
 catch (  UncheckedExecutionException e) {
    if (from == State.STOPPING) {
      assertEquals(failure,e.getCause());
    }
 else {
      assertEquals(failure,e.getCause().getCause());
    }
  }
  completionLatch.countDown();
}

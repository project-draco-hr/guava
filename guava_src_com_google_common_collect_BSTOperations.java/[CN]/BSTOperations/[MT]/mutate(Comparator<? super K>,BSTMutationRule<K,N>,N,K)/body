{
  checkNotNull(comparator);
  checkNotNull(mutationRule);
  checkNotNull(key);
  BSTBalancePolicy<N> rebalancePolicy=mutationRule.getBalancePolicy();
  BSTNodeFactory<N> nodeFactory=mutationRule.getNodeFactory();
  BSTModifier<K,N> modifier=mutationRule.getModifier();
  if (tree != null) {
    int cmp=comparator.compare(key,tree.getKey());
    if (cmp != 0) {
      BSTSide side=(cmp < 0) ? LEFT : RIGHT;
      BSTMutationResult<K,N> mutation=mutate(comparator,mutationRule,tree.childOrNull(side),key);
      return mutation.lift(tree,side,nodeFactory,rebalancePolicy);
    }
  }
  N newTree=modifier.modify(key,tree);
  if (newTree == tree) {
    return BSTMutationResult.identity(key,tree,tree);
  }
 else   if (newTree == null) {
    newTree=rebalancePolicy.combine(nodeFactory,tree.childOrNull(LEFT),tree.childOrNull(RIGHT));
  }
 else {
    N left=null;
    N right=null;
    if (tree != null) {
      left=tree.childOrNull(LEFT);
      right=tree.childOrNull(RIGHT);
    }
    newTree=rebalancePolicy.balance(nodeFactory,newTree,left,right);
  }
  return BSTMutationResult.mutationResult(key,tree,newTree,tree,newTree);
}

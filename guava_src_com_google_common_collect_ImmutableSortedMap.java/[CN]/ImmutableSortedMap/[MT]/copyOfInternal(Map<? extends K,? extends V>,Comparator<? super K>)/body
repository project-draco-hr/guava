{
  boolean sameComparator=false;
  if (map instanceof SortedMap) {
    SortedMap<?,?> sortedMap=(SortedMap<?,?>)map;
    Comparator<?> comparator2=sortedMap.comparator();
    sameComparator=(comparator2 == null) ? comparator == NATURAL_ORDER : comparator.equals(comparator2);
  }
  if (sameComparator && (map instanceof ImmutableSortedMap)) {
    @SuppressWarnings("unchecked") ImmutableSortedMap<K,V> kvMap=(ImmutableSortedMap<K,V>)map;
    if (!kvMap.isPartialView()) {
      return kvMap;
    }
  }
  @SuppressWarnings("unchecked") Entry<K,V>[] entries=map.entrySet().toArray(new Entry[0]);
  for (int i=0; i < entries.length; i++) {
    Entry<K,V> entry=entries[i];
    entries[i]=entryOf(entry.getKey(),entry.getValue());
  }
  List<Entry<K,V>> list=Arrays.asList(entries);
  if (!sameComparator) {
    sortEntries(list,comparator);
    validateEntries(list,comparator);
  }
  return fromSortedEntries(comparator,list);
}

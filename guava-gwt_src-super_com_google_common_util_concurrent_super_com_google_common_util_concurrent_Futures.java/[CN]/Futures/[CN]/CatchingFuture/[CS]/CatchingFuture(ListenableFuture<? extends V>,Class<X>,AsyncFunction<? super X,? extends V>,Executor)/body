{
  checkNotNull(exceptionType);
  checkNotNull(fallback);
  running=input;
  input.addListener(new Runnable(){
    @Override public void run(){
      ListenableFuture<? extends V> localRunning=running;
      running=null;
      if (localRunning == null | isCancelled()) {
        return;
      }
      Throwable throwable;
      try {
        set(getUninterruptibly(localRunning));
        return;
      }
 catch (      ExecutionException e) {
        throwable=e.getCause();
      }
catch (      Throwable e) {
        throwable=e;
      }
      try {
        if (isInstanceOfThrowableClass(throwable,exceptionType)) {
          @SuppressWarnings("unchecked") X castThrowable=(X)throwable;
          ListenableFuture<? extends V> replacement=fallback.apply(castThrowable);
          checkNotNull(replacement,"AsyncFunction.apply returned null instead of a Future. " + "Did you mean to return immediateFuture(null)?");
          setFuture(replacement);
        }
 else {
          setException(throwable);
        }
      }
 catch (      Throwable e) {
        setException(e);
      }
    }
  }
,executor);
}

{
  int smearedKeyHash=Hashing.smearedHash(key);
  int smearedValueHash=Hashing.smearedHash(value);
  BiEntry<K,V> oldEntryForKey=seekByKey(key,smearedKeyHash);
  if (oldEntryForKey != null && oldEntryForKey.matchesValue(value,smearedValueHash)) {
    return value;
  }
  BiEntry<K,V> oldEntryForValue=seekByValue(value,smearedValueHash);
  if (oldEntryForValue != null) {
    if (force) {
      delete(oldEntryForValue);
    }
 else {
      throw new IllegalArgumentException("value already present: " + value);
    }
  }
  if (oldEntryForKey != null) {
    delete(oldEntryForKey);
  }
  BiEntry<K,V> newEntry=new BiEntry<K,V>(key,smearedKeyHash,value,smearedValueHash);
  insert(newEntry);
  rehashIfNecessary();
  return valueOrNull(oldEntryForKey);
}
